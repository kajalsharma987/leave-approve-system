<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Approval Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100 p-4">

    <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden md:flex">

        <div id="auth-section" class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center items-center">
            <h2 id="auth-title" class="text-3xl font-bold text-gray-800 mb-6">Login</h2>

            <form id="login-form" class="w-full max-w-sm space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out">Login</button>
            </form>

            <form id="register-form" class="w-full max-w-sm space-y-6 hidden">
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="register-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="John Doe" required>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="register-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="your@example.com" required>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="register-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
                </div>
                <div>
                    <label for="register-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="register-role" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select Role</option>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option> </select>
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out">Register</button>
            </form>

            <p class="mt-6 text-gray-600 text-sm">
                <span id="toggle-auth-text">Don't have an account?</span>
                <button id="toggle-auth-btn" class="text-blue-600 hover:underline font-medium ml-1">Register</button>
            </p>
        </div>

        <div class="hidden md:block md:w-1/2 bg-gradient-to-br from-blue-500 to-purple-600 p-8 flex items-center justify-center">
            <div class="text-white text-center">
                <h3 class="text-3xl font-bold mb-4">Welcome to the Leave Portal!</h3>
                <p class="text-lg opacity-90">Manage your leaves effortlessly.</p>
                <svg class="mx-auto mt-8 w-32 h-32 text-white opacity-80" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.8 6-3.8s5.97 1.81 6 3.8c-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
            </div>
        </div>

        <div id="dashboard-section" class="w-full hidden p-8 md:p-10">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-4 md:mb-0">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-display-name" class="text-lg font-medium text-gray-700"></span>
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition duration-300 ease-in-out">Logout</button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <nav class="md:col-span-1 bg-gray-50 p-6 rounded-lg shadow-sm">
                    <ul class="space-y-4">
                        <li>
                            <button id="nav-apply-leave" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition duration-200 ease-in-out font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Apply for Leave
                            </button>
                        </li>
                        <li>
                            <button id="nav-my-leaves" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition duration-200 ease-in-out font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                My Leave Applications
                            </button>
                        </li>
                        <li id="nav-pending-approvals-item" class="hidden">
                            <button id="nav-pending-approvals" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition duration-200 ease-in-out font-medium">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.001 12.001 0 002 12c0 2.757 1.125 5.228 2.938 7.072l-.001.002c.001.001.001.001.002.002A12.001 12.001 0 0012 22c2.757 0 5.228-1.125 7.072-2.938l.002-.001c.001-.001.001-.001.002-.002A12.001 12.001 0 0022 12c0-2.757-1.125-5.228-2.938-7.072l-.002-.001z"></path></svg>
                                Pending Approvals
                                <span id="pending-count" class="ml-auto bg-red-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full">0</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-sm min-h-[500px]">
                    <div id="apply-leave-section" class="content-section">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Apply for Leave</h2>
                        <form id="leave-application-form" class="space-y-6">
                            <div>
                                <label for="leave-type" class="block text-sm font-medium text-gray-700 mb-1">Leave Type</label>
                                <select id="leave-type" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select Leave Type</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="casual">Casual Leave</option>
                                    <option value="family">Family Event</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="start-date" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="end-date" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="leave-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                                <textarea id="leave-reason" rows="4" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Briefly describe your reason for leave..." required></textarea>
                            </div>
                            <button type="submit" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out">Submit Leave Request</button>
                        </form>
                    </div>

                    <div id="my-leaves-section" class="content-section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">My Leave Applications</h2>
                        <div id="my-leaves-list" class="space-y-4">
                            <p class="text-gray-500" id="no-my-leaves-message">No leave applications submitted yet.</p>
                        </div>
                    </div>

                    <div id="pending-approvals-section" class="content-section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Pending Approvals</h2>
                        <div id="pending-approvals-list" class="space-y-4">
                            <p class="text-gray-500" id="no-pending-approvals-message">No pending leave requests.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports (इन्हें वैसे ही रहने दें)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let currentFirebaseUser = null; // Firebase Auth user object
        let currentUserProfile = null; // User profile data from Firestore

        // DOM Elements... (बाकी DOM एलिमेंट्स वैसे ही रहेंगे)
        // ...

        // **************** यहाँ अपनी Firebase कॉन्फ़िगरेशन पेस्ट करें ****************
        // इसे Firebase Console से कॉपी किया गया है
        const firebaseConfig = {
            apiKey: "AIzaSyC*********************", // अपनी actual API Key यहाँ पेस्ट करें
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890abcdef", // अपनी actual App ID यहाँ पेस्ट करें
            // measurementId: "G-XXXXXXXXXX" // अगर है तो इसे भी जोड़ें
        };

        // यह appId आपके Firestore paths में उपयोग होगा (artifacts/{appId}/...)
        const appId = firebaseConfig.appId;
        // *******************************************************************

        // --- Utility Functions ---
        // ... (यह सेक्शन वैसे ही रहेगा)

        // --- Auth Logic ---
        // ... (यह सेक्शन वैसे ही रहेगा)

        // --- Dashboard & Leave Application Logic ---
        // ... (यह सेक्शन वैसे ही रहेगा)


        // --- Initial Load & Firebase Initialization ---

        // Close modal on button click
        modalCloseBtn.addEventListener('click', hideMessageModal);

        window.onload = async () => {
            // पुरानी लाइन्स को हटा दें या टिप्पणी करें:
            // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // अब सीधे firebaseConfig ऑब्जेक्ट का उपयोग करें जो आपने ऊपर पेस्ट किया है
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentFirebaseUser = user;
                        // Fetch user profile from Firestore
                        currentUserProfile = await getUserProfile(user.uid);
                        if (currentUserProfile) {
                            renderDashboard();
                            // Setup Firestore listeners for data
                            setupFirestoreListeners();
                        } else {
                            // If user exists in Auth but not in Firestore profile (e.g., deleted profile)
                            console.warn("User profile not found in Firestore for UID:", user.uid);
                            showMessageModal('Profile Missing', 'Your user profile could not be loaded. Please contact support or re-register.');
                            await signOut(auth); // Force logout
                        }
                    } else {
                        // User is signed out
                        currentFirebaseUser = null;
                        currentUserProfile = null;
                        authSection.classList.remove('hidden');
                        dashboardSection.classList.add('hidden');
                        // Unsubscribe from listeners when logged out
                        if (unsubscribeMyLeaves) unsubscribeMyLeaves();
                        if (unsubscribePendingApprovals) unsubscribePendingApprovals();
                        loginForm.reset(); // Reset login form
                    }
                });

                // Attempt to sign in with custom token or anonymously if not already signed in
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                }
            } else {
                console.error("Firebase config not found. Cannot connect to database.");
                showMessageModal('Error', 'Firebase configuration missing. Please provide Firebase config to enable database features.');
            }
        };

    </script>
</body>
</html>
